<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>电子玫瑰</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #000;
        }
        #roseCanvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }
        /* 隐藏音频控制 */
        #backgroundMusic {
            display: none;
        }
    </style>
</head>
<body>
    <canvas id="roseCanvas"></canvas>
    <audio id="backgroundMusic" loop>
        <source src="BadApple.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <script>
        const canvas = document.getElementById('roseCanvas');
        const ctx = canvas.getContext('2d');
        const music = document.getElementById('backgroundMusic');

        // 设置Canvas尺寸
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const rosesize = 500;
        const h = -250;

        // 定义结构体
        class DOT {
            constructor(x = 0, y = 0, z = 0, r = 0, g = 0) {
                this.x = x;
                this.y = y;
                this.z = z;
                this.r = r;
                this.g = g;
            }
        }

        // 初始化Z-buffer
        const zBuffer = new Float32Array(canvas.width * canvas.height).fill(Infinity);

        // 播放音乐
        window.onload = () => {
            music.play().catch((error) => {
                console.log("自动播放被阻止。用户需要手动播放音乐。");
            });
        };

        // 计算点
        function calc(a, b, c, d) {
            let j, n, o, w, z;

            if (c > 60) { // 花柄
                d.x = Math.sin(a * 7) * (13 + 5 / (0.2 + Math.pow(b * 4, 4))) - Math.sin(b) * 50;
                d.y = b * rosesize + 50;
                d.z = 625 + Math.cos(a * 7) * (13 + 5 / (0.2 + Math.pow(b * 4, 4))) + b * 400;
                d.r = a * 1 - b / 2;
                d.g = a;
                return true;
            }
            let A = a * 2 - 1;
            let B = b * 2 - 1;
            if (A * A + B * B < 1) { // 绿叶
                if (c > 37) {
                    j = (Math.floor(c) & 1) ? 6 : 4;
                    n = j ? 6 : 4;
                    o = 0.5 / (a + 0.01) + Math.cos(b * 125) * 3 - a * 300;
                    w = b * h;
                    d.x = o * Math.cos(n) + w * Math.sin(n) + (j ? 610 : -390);
                    d.y = o * Math.sin(n) - w * Math.cos(n) + 550 - j * 350;
                    d.z = 1180 + Math.cos(B + A) * 99 - j * 300;
                    d.r = 0.4 - a * 0.1 + Math.pow(1 - B * B, -h * 6) * 0.15 - a * b * 0.4 + Math.cos(a + b) / 5 +
                          Math.pow(Math.cos((o * (a + 1) + (B > 0 ? w : -w)) / 25), 30) * 0.1 * (1 - B * B);
                    d.g = o / 1000 + 0.7 - o * w * 0.000003;
                    return true;
                }

                if (c > 32) { // 花萼
                    c = c * 1.16 - 0.15;
                    o = a * 45 - 20;
                    w = b * b * h;
                    z = o * Math.sin(c) + w * Math.cos(c) + 620;
                    d.x = o * Math.cos(c) - w * Math.sin(c);
                    d.y = 28 + Math.cos(B * 0.5) * 99 - Math.pow(b, 3) * 60 - z / 2 - h;
                    d.z = z;
                    d.r = (Math.pow(b, 2) * 0.3 + Math.pow((1 - (A * A)), 7) * 0.15 + 0.3) * b;
                    d.g = b * 0.7;
                    return true;
                }

                // 花朵
                o = A * (2 - b) * (80 - c * 2);
                w = 99 - Math.cos(A) * 120 - Math.cos(b) * (-h - c * 4.9) + Math.cos(Math.pow(1 - b, 7)) * 50 + c * 2;
                z = o * Math.sin(c) + w * Math.cos(c) + 700;
                d.x = o * Math.cos(c) - w * Math.sin(c);
                d.y = B * 99 - Math.cos(Math.pow(b, 7)) * 50 - c / 3 - z / 1.35 + 450;
                d.z = z;
                d.r = (1 - b / 1.2) * 0.9 + a * 0.1;
                d.g = Math.pow((1 - b), 20) / 4 + 0.05;
                return true;
            }

            return false;
        }

        // 主渲染循环
        function render() {
            for (let j = 0; j < 10000; j++) {
                const a = Math.random();
                const b = Math.random();
                const c = (Math.floor(Math.random() * 46)) / 0.74;
                const dot = new DOT();

                if (calc(a, b, c, dot)) {
                    const z = Math.round(dot.z + 0.5);
                    const x = Math.round(dot.x * rosesize / z - h + 0.5) + canvas.width / 2;
                    const y = Math.round(dot.y * rosesize / z - h + 0.5) + canvas.height / 2;

                    if (y > canvas.height || y < 0 || x > canvas.width || x < 0) continue;

                    const zBufferIndex = y * canvas.width + x;

                    if (z < zBuffer[zBufferIndex]) {
                        zBuffer[zBufferIndex] = z;

                        // 颜色计算
                        let r = ~Math.round(dot.r * h);
                        r = Math.max(0, Math.min(255, r));

                        let g = ~Math.round(dot.g * h);
                        g = Math.max(0, Math.min(255, g));

                        let blue = ~Math.round((dot.r * dot.r * -80));
                        blue = Math.max(0, Math.min(255, blue));

                        ctx.fillStyle = `rgb(${r}, ${g}, ${blue})`;
                        ctx.fillRect(x, y, 1, 1);
                    }
                }
            }

            // 递归调用渲染函数
            requestAnimationFrame(render);
        }

        // 初始化渲染
        render();

        // 调整窗口大小时更新Canvas尺寸和Z-buffer
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            // 重置Z-buffer
            for (let i = 0; i < zBuffer.length; i++) {
                zBuffer[i] = Infinity;
            }
        });
    </script>
</body>
</html>
